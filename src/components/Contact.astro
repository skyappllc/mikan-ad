---
import { CONTACT_EMAIL } from '../data/site';
import ContactForm from './ContactForm.astro';
---

<section
  id="contact"
  class="relative py-20 md:py-28 overflow-hidden bg-ink"
  aria-labelledby="contact-heading"
>
  <!-- 装飾: 斜線パターン背景 (白線) -->
  <div
    class="absolute inset-0 pointer-events-none opacity-5"
    style="background-image: repeating-linear-gradient(45deg, white, white 1px, transparent 1px, transparent 10px);"
    aria-hidden="true"
  ></div>

  <!-- 装飾: 右上の円 -->
  <div class="absolute -top-16 -right-16 w-64 h-64 rounded-full border-[4px] border-white opacity-5 pointer-events-none" aria-hidden="true"></div>

  <!-- 装飾: 左下の四角形 -->
  <div class="absolute -bottom-8 -left-8 w-32 h-32 border-[4px] border-mikan rotate-12 opacity-10 pointer-events-none" aria-hidden="true"></div>

  <div class="relative z-10 max-w-6xl mx-auto px-4 sm:px-6">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 items-start">

      <!-- テキスト -->
      <div data-reveal>
        <span class="inline-block px-4 py-1 bg-mikan text-white font-bold text-xs tracking-widest uppercase mb-6">
          Contact
        </span>
        <h2
          id="contact-heading"
          class="font-display text-4xl md:text-5xl lg:text-6xl text-white leading-tight mb-6"
        >
          お問い合わせ
        </h2>
        <p class="text-lg text-white opacity-70 leading-relaxed mb-8">
          システム開発のお見積もり、AI活用のご相談など、
          お気軽にお問い合わせください。<br class="hidden md:block" />
          担当者より迅速にご返答いたします。
        </p>

        <!-- 対応項目リスト -->
        <ul class="flex flex-col gap-3 mb-8" role="list">
          {['システム開発・Webアプリの見積もり', 'AI活用・開発のご相談', 'プロジェクトマネジメント', 'その他ビジネス上のご相談'].map((item) => (
            <li class="flex items-center gap-3 text-white">
              <span class="flex-shrink-0 w-6 h-6 bg-mikan border-2 border-mikan-light flex items-center justify-center text-white text-xs font-black" aria-hidden="true">
                ✓
              </span>
              <span class="text-sm font-medium opacity-85">{item}</span>
            </li>
          ))}
        </ul>

      </div>

      <!-- フォームカード -->
      <div data-reveal data-reveal-delay="2" class="relative">
        <div class="p-8 md:p-10 bg-white border-[3px] border-mikan brutal-shadow-lg-orange">

          <h3 class="text-xl font-black text-ink mb-6">
            お問い合わせフォーム
          </h3>

          <ContactForm />

          <!-- mailto フォールバック -->
          <p class="text-xs text-ink opacity-40 text-center mt-6">
            フォームが使えない場合は
            <a
              href={`mailto:${CONTACT_EMAIL}?subject=お問い合わせ（コーポレートサイトより）`}
              class="underline hover:text-mikan transition-colors"
            >{CONTACT_EMAIL}</a>
            まで直接ご連絡ください。
          </p>
        </div>

        <!-- 成功オーバーレイ -->
        <div
          id="form-success-overlay"
          class="hidden absolute inset-0 bg-white border-[3px] border-mikan brutal-shadow-lg-orange flex flex-col items-center justify-center p-10 text-center"
          role="status"
          aria-live="polite"
        >
          <div class="text-6xl mb-4" aria-hidden="true">✅</div>
          <h3 class="text-2xl font-black text-ink mb-3">送信完了！</h3>
          <p class="text-sm text-ink opacity-70 leading-relaxed mb-8" id="success-message">
            お問い合わせを受け付けました。<br />担当者より速やかにご連絡いたします。
          </p>
          <button
            id="reset-btn"
            class="px-8 py-3 bg-mikan text-white font-black text-sm brutal-btn"
          >
            新しいお問い合わせ
          </button>
        </div>
      </div>

    </div>
  </div>
</section>

<script>
  // タイムスタンプをセット（ページ読み込み時刻）
  const tsInput = document.getElementById('_timestamp') as HTMLInputElement | null;
  if (tsInput) tsInput.value = String(Date.now());

  // ---- バリデーション ----
  const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  function showError(field: string, msg: string) {
    const el = document.querySelector<HTMLElement>(`[data-error="${field}"]`);
    const input = document.getElementById(field) as HTMLElement | null;
    if (el) { el.textContent = msg; el.classList.remove('hidden'); }
    if (input) { input.classList.add('error'); }
  }

  function clearError(field: string) {
    const el = document.querySelector<HTMLElement>(`[data-error="${field}"]`);
    const input = document.getElementById(field) as HTMLElement | null;
    if (el) { el.textContent = ''; el.classList.add('hidden'); }
    if (input) { input.classList.remove('error'); }
  }

  function validateField(name: string, value: unknown): string | null {
    const v = String(value ?? '').trim();
    switch (name) {
      case 'name':
        if (!v) return 'お名前を入力してください。';
        if (v.length > 100) return 'お名前は100文字以内で入力してください。';
        return null;
      case 'email':
        if (!v) return 'メールアドレスを入力してください。';
        if (!EMAIL_RE.test(v)) return '正しいメールアドレスを入力してください。';
        return null;
      case 'company_name':
        if (v.length > 100) return '会社名は100文字以内で入力してください。';
        return null;
      case 'inquiry_type':
        if (!v) return 'お問い合わせ種別を選択してください。';
        return null;
      case 'message':
        if (!v) return 'お問い合わせ内容を入力してください。';
        if (v.length < 10) return '10文字以上入力してください。';
        if (v.length > 2000) return '2000文字以内で入力してください。';
        return null;
      default:
        return null;
    }
  }

  // ---- 文字カウンター ----
  const messageEl = document.getElementById('message') as HTMLTextAreaElement | null;
  const charCount = document.getElementById('char-count');
  if (messageEl && charCount) {
    messageEl.addEventListener('input', () => {
      charCount.textContent = String(messageEl.value.length);
    });
  }

  // ---- blur 時バリデーション ----
  function getVal(el: HTMLElement): unknown {
    return (el as HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement).value;
  }

  const fields = ['name', 'email', 'company_name', 'inquiry_type', 'message'];
  fields.forEach((fieldName) => {
    const el = document.getElementById(fieldName);
    if (!el) return;
    el.addEventListener('blur', () => {
      const err = validateField(fieldName, getVal(el));
      if (err) showError(fieldName, err);
      else clearError(fieldName);
    });
    el.addEventListener('input', () => {
      const err = validateField(fieldName, getVal(el));
      if (!err) clearError(fieldName);
    });
  });

  // ---- 送信ハンドラ ----
  const form = document.getElementById('contact-form') as HTMLFormElement | null;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
  const submitLabel = document.getElementById('submit-label');
  const serverError = document.getElementById('form-server-error');
  const overlay = document.getElementById('form-success-overlay');
  const successMessage = document.getElementById('success-message');
  const resetBtn = document.getElementById('reset-btn');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // フロントバリデーション
    let hasError = false;
    fields.forEach((fieldName) => {
      const el = document.getElementById(fieldName);
      if (!el) return;
      const err = validateField(fieldName, getVal(el));
      if (err) {
        showError(fieldName, err);
        hasError = true;
      }
    });

    if (hasError) {
      form.classList.add('shake');
      form.addEventListener('animationend', () => form.classList.remove('shake'), { once: true });
      const firstError = form.querySelector<HTMLElement>('.error');
      firstError?.focus();
      return;
    }

    // 送信中状態
    if (submitBtn) submitBtn.disabled = true;
    if (submitLabel) submitLabel.textContent = '送信中...';
    if (serverError) serverError.classList.add('hidden');

    const data = {
      name:         (document.getElementById('name') as HTMLInputElement).value,
      email:        (document.getElementById('email') as HTMLInputElement).value,
      company:      (document.getElementById('company_name') as HTMLInputElement).value,
      inquiry_type: (document.getElementById('inquiry_type') as HTMLSelectElement).value,
      message:      (document.getElementById('message') as HTMLTextAreaElement).value,
      _honey:       (document.getElementById('_honey') as HTMLInputElement)?.value ?? '',
      _timestamp:   (document.getElementById('_timestamp') as HTMLInputElement)?.value ?? '',
    };

    try {
      const res = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      const json = await res.json() as { success: boolean; message?: string; error?: string };

      if (json.success) {
        if (successMessage && json.message) successMessage.innerHTML = json.message.replace(/\n/g, '<br>');
        overlay?.classList.remove('hidden');
        overlay?.classList.add('flex');
      } else {
        if (serverError) {
          serverError.textContent = json.error ?? '送信に失敗しました。直接メールにてご連絡ください。';
          serverError.classList.remove('hidden');
        }
        if (submitBtn) submitBtn.disabled = false;
        if (submitLabel) submitLabel.textContent = '送信する';
      }
    } catch {
      if (serverError) {
        serverError.textContent = 'ネットワークエラーが発生しました。しばらく経ってから再度お試しください。';
        serverError.classList.remove('hidden');
      }
      if (submitBtn) submitBtn.disabled = false;
      if (submitLabel) submitLabel.textContent = '送信する';
    }
  });

  // ---- リセット ----
  resetBtn?.addEventListener('click', () => {
    form?.reset();
    if (charCount) charCount.textContent = '0';
    fields.forEach(clearError);
    if (serverError) serverError.classList.add('hidden');
    overlay?.classList.add('hidden');
    overlay?.classList.remove('flex');
    if (submitBtn) submitBtn.disabled = false;
    if (submitLabel) submitLabel.textContent = '送信する';
    // タイムスタンプを更新
    if (tsInput) tsInput.value = String(Date.now());
  });
</script>
